<!DOCTYPE html>
<html>
<body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h1>Pasco Properties</h1>

<h2 onclick="q1()">Query 1</h1>
<h2 onclick="q2()">Query 2</h1>
<h2 onclick="q3()">Query 3</h1>
<h2 onclick="q4()">Query 4</h1>
<h2 onclick="q5()">Query 5</h1>

<h2 id="query-description">  </h2>

<h3 id= "query-prompt"></h3>

<form id="userInput"></form>

<canvas id = "myChart"></canvas>

<script src ="./node_modules/requirejs/require.js"></script>
<script>



function q1(){

  // Show query description and user prompt
  document.getElementById("query-description").innerHTML= "What was the average price in a given zip code?";
  document.getElementById("query-prompt").innerHTML="Enter a zip code:"
   // create form for user input
  const qform = document.getElementById("userInput");
  const in1 = document.createElement("input");
  in1.type = "number";
  in1.id= "zipcode";
  const sub = document.createElement("input");
  sub.type = "submit";
  const temp = qform.replaceChildren(in1, sub);
  // set up submit button
  qform.addEventListener("submit", (e) => {
      e.preventDefault();
     z = document.getElementById("zipcode").value;
    console.log(z);
  })
}

 
function q2(){
    // Show query description and user prompt
    document.getElementById("query-description").innerHTML= "What percentage of sales occurred in a given zip code?";
    document.getElementById("query-prompt").innerHTML="Enter a zip code:"
    // create form for user input
    const qform = document.getElementById("userInput");
    const in1 = document.createElement("input");
    in1.type = "number";
    in1.id= "zipcode";
    const sub = document.createElement("input");
    sub.type = "submit";
    const temp = qform.replaceChildren(in1, sub);
    // set up submit button
    qform.addEventListener("submit", (e) => {
      e.preventDefault();
      z = document.getElementById("zipcode").value;
      console.log(z);
      let text_query = "WITH sales_with_year AS (\
        SELECT Sale_ID, Parcel_ID, EXTRACT(year FROM Sale_Date) year\
        FROM SALE_TEST\
        ),\
        sales_per_year_total(year, sales) AS (\
        SELECT year, count(*)\
        FROM sales_with_year\
        GROUP BY year\
        ),\
        sales_per_year_zip(year, sales) AS (\
        SELECT year, count(*)\
        FROM sales_with_year, parcel_test\
        WHERE sales_with_year.parcel_ID = parcel_test.parcel_ID AND parcel_test.site_zip = ";
        text_query += z;
        text_query += " GROUP BY year\
        )\
        SELECT sales_per_year_total.year, (sales_per_year_zip.sales / sales_per_year_total.sales) AS percent\
        FROM sales_per_year_zip, sales_per_year_total\
        WHERE sales_per_year_total.year = sales_per_year_zip.year\
        ORDER BY year"
        //console.log(text_query);
      runq1(text_query);
  
  
  
  
    })
  
  }
  
  async function runq1(q) {
    //const oracledb = requirejs('oracledb');
    require(['oracledb'], function (oracledb) {
    //foo is now loaded.
    });

    let connection;
    try {
      connection = await oracledb.getConnection({ user: "t.schneider", password: "yGzNUcY59fEFBnud0YFaDOmT", connectionString: "oracle.cise.ufl.edu/orcl" });
      console.log("Successfully connected to Oracle Database");
      let result = await connection.execute(q);
      let years = [];
        let percentages =[];
        result.rows.forEach((pair) => {
          years.push(pair[0]);
          percentages.push(pair[1]);
        })
        console.log(years)
        console.log(percentages)
    } catch (err) {
      console.error(err);
    } finally {
      if (connection) {
        try {
          await connection.close();
        } catch (err) {
          console.error(err);
        }
      }
    }
  }

  function q3() {
    document.getElementById("query-description").innerHTML= "Are tax exemptions being exploited to avoid paying fair tax rates?";
  }
  
  function q4(){
    document.getElementById("query-description").innerHTML= "What is the median lot size by year built?";
  }
  
  function q5() {
    document.getElementById("query-description").innerHTML= "How has the value of a house changed over time?";
  }
  
</script>


</body>
</html>